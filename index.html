<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quotex Pro - Advanced Trading Platform</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/theme/monokai.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        body {
            background-color: #0c111c;
            color: white;
            height: 100vh;
            display: flex;
            overflow: hidden;
        }

        /* Sidebar */
        .sidebar {
            width: 300px;
            background-color: #1e293b;
            border-right: 1px solid #334155;
            padding: 16px;
            overflow-y: auto;
        }

        .logo-container {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .logo {
            width: 32px;
            height: 32px;
            border-radius: 6px;
        }

        .platform-title {
            font-size: 18px;
            font-weight: bold;
            color: #3b82f6;
        }

        .symbol-selector {
            margin-bottom: 20px;
        }

        .symbol-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .symbol-title {
            font-size: 16px;
            font-weight: 500;
        }

        .add-symbol {
            width: 24px;
            height: 24px;
            background-color: #3b82f6;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
        }

        .symbol-list {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin-top: 8px;
            display: none;
        }

        .symbol-item {
            padding: 8px;
            background-color: #334155;
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .symbol-item:hover {
            background-color: #475569;
        }

        .symbol-item.active {
            background-color: #3b82f6;
            color: white;
        }

        .symbol-chips {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .symbol-chip {
            padding: 6px 12px;
            background-color: #3b82f6;
            border-radius: 16px;
            font-size: 13px;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .chip-close {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: white;
            color: #3b82f6;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            cursor: pointer;
        }

        /* Main Content */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* Topbar */
        .topbar {
            background-color: #1e293b;
            border-bottom: 1px solid #334155;
            padding: 12px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chart-controls {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        .timeframe-container {
            position: relative;
            display: inline-block;
        }

        .timeframe-display {
            padding: 6px 12px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .timeframe-display:hover {
            background-color: #475569;
        }

        .timeframe-list {
            position: absolute;
            top: 100%;
            left: 0;
            background-color: #1e293b;
            border: 1px solid #334155;
            border-radius: 6px;
            margin-top: 4px;
            display: none;
            z-index: 100;
            max-height: 300px;
            overflow-y: auto;
            min-width: 120px;
        }

        .timeframe-option {
            padding: 8px 12px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }

        .timeframe-option:hover {
            background-color: #334155;
        }

        .timeframe-option.active {
            background-color: #3b82f6;
            color: white;
        }

        .tools-container {
            display: flex;
            gap: 8px;
        }

        .tool-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background-color: #334155;
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .tool-btn:hover {
            background-color: #475569;
        }

        .tool-btn.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        /* Chart Container */
        .chart-container {
            flex: 1;
            padding: 16px;
            position: relative;
            overflow: hidden;
        }

        .chart-wrapper {
            width: 100%;
            height: 100%;
            border: 1px solid #334155;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            background-color: #0f172a;
            overflow: hidden;
            position: relative;
        }

        .chart-canvas {
            width: 100%;
            height: 100%;
            cursor: grab;
        }

        .chart-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .chart-legend {
            position: absolute;
            top: 16px;
            left: 16px;
            background-color: rgba(0, 0, 0, 0.7);
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 12px;
            z-index: 10;
        }

        .legend-item {
            color: #cbd5e1;
            margin-bottom: 4px;
        }

        .legend-item:last-child {
            margin-bottom: 0;
        }

        .legend-indicator {
            color: #3b82f6;
        }

        .legend-fibonacci {
            color: #f59e0b;
        }

        .active-indicators {
            position: absolute;
            top: 16px;
            right: 16px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            z-index: 10;
        }

        .active-indicator {
            background-color: rgba(0, 0, 0, 0.7);
            padding: 6px 12px;
            border-radius: 6px;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .indicator-close {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background-color: #ef4444;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            cursor: pointer;
        }

        .navigation-controls {
            position: absolute;
            bottom: 16px;
            right: 16px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .nav-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .nav-btn:hover {
            background-color: rgba(51, 65, 85, 0.7);
        }

        .nav-btn.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .zoom-controls {
            position: absolute;
            bottom: 16px;
            right: 160px;
            display: flex;
            gap: 8px;
            z-index: 10;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background-color: rgba(0, 0, 0, 0.7);
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 16px;
        }

        .zoom-btn:hover {
            background-color: rgba(51, 65, 85, 0.7);
        }

        /* Drawing Tools Panel */
        .drawing-panel {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background-color: rgba(30, 41, 59, 0.9);
            border-radius: 8px;
            padding: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 10;
            display: flex;
            gap: 6px;
            flex-wrap: wrap;
            max-width: 600px;
        }

        .drawing-tool {
            width: 32px;
            height: 32px;
            border-radius: 6px;
            background-color: #334155;
            border: 1px solid #475569;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 14px;
        }

        .drawing-tool:hover {
            background-color: #475569;
        }

        .drawing-tool.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        /* Drawing Settings Panel */
        .drawing-settings {
            position: absolute;
            bottom: 16px;
            left: 16px;
            background-color: rgba(30, 41, 59, 0.9);
            border-radius: 8px;
            padding: 16px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            z-index: 11;
            display: none;
            min-width: 300px;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .settings-title {
            font-size: 16px;
            font-weight: 500;
            color: #3b82f6;
        }

        .settings-close {
            background: none;
            border: none;
            font-size: 18px;
            color: #94a3b8;
            cursor: pointer;
            width: 28px;
            height: 28px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .settings-close:hover {
            background-color: #334155;
            color: white;
        }

        .form-group {
            margin-bottom: 16px;
        }

        .form-group label {
            display: block;
            font-size: 14px;
            margin-bottom: 8px;
            color: #cbd5e1;
        }

        .form-control {
            width: 100%;
            padding: 8px 12px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .color-picker {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .color-option {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .color-option.active {
            border-color: white;
        }

        .color-custom {
            background: linear-gradient(45deg, red, orange, yellow, green, blue, indigo, violet);
        }

        .line-style {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .style-option {
            padding: 6px 8px;
            background-color: #334155;
            border: 1px solid #475569;
            border-radius: 4px;
            font-size: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .style-option:hover {
            background-color: #475569;
        }

        .style-option.active {
            background-color: #3b82f6;
            border-color: #3b82f6;
            color: white;
        }

        .settings-footer {
            display: flex;
            justify-content: flex-end;
            gap: 12px;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid #475569;
        }

        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .btn-primary:hover {
            background-color: #2563eb;
        }

        .btn-secondary {
            background-color: #64748b;
            color: white;
        }

        .btn-secondary:hover {
            background-color: #475569;
        }

        .btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .btn-danger:hover {
            background-color: #dc2626;
        }

        /* Indicators Modal */
        .indicators-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            display: none;
        }

        .modal-content {
            background-color: #1e293b;
            border-radius: 12px;
            width: 800px;
            max-width: 90%;
            max-height: 90vh;
            overflow: hidden;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #334155;
            background-color: #1e293b;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 500;
            color: #3b82f6;
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 20px;
            color: #94a3b8;
            cursor: pointer;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.2s;
        }

        .modal-close:hover {
            background-color: #334155;
            color: white;
        }

        .modal-body {
            padding: 16px;
            max-height: calc(90vh - 120px);
            overflow-y: auto;
        }

        .indicators-categories {
            display: flex;
            border-bottom: 1px solid #334155;
            margin-bottom: 16px;
        }

        .category-tab {
            padding: 12px 16px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            border-bottom: 2px solid transparent;
        }

        .category-tab:hover {
            background-color: #334155;
        }

        .category-tab.active {
            border-bottom: 2px solid #3b82f6;
            color: #3b82f6;
            font-weight: 500;
        }

        .indicators-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
        }

        .indicator-item {
            padding: 12px;
            background-color: #334155;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .indicator-item:hover {
            background-color: #475569;
        }

        .indicator-item.active {
            background-color: #10b981;
            color: white;
        }

        .indicator-name {
            font-weight: 500;
            margin-bottom: 4px;
        }

        .indicator-desc {
            font-size: 11px;
            opacity: 0.8;
        }

        /* Indicator Settings Modal */
        .settings-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
            display: none;
        }

        .settings-content {
            background-color: #1e293b;
            border-radius: 12px;
            width: 500px;
            max-width: 90%;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 24px;
            border-bottom: 1px solid #334155;
            background-color: #1e293b;
        }

        .settings-title {
            font-size: 18px;
            font-weight: 500;
            color: #3b82f6;
        }

        .settings-body {
            padding: 24px;
        }

        .settings-footer {
            padding: 16px 24px;
            border-top: 1px solid #334155;
            display: flex;
            justify-content: flex-end;
            gap: 12px;
        }

        /* Pine Editor */
        .pine-editor {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            height: 100%;
            background-color: #111827;
            z-index: 1000;
            display: none;
            flex-direction: column;
            border-left: 1px solid #334155;
        }

        .editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 24px;
            background-color: #1e293b;
            border-bottom: 1px solid #334155;
        }

        .editor-title {
            font-weight: 500;
            font-size: 16px;
            color: #3b82f6;
        }

        .editor-actions {
            display: flex;
            gap: 12px;
        }

        .editor-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
        }

        .editor-btn-primary {
            background-color: #3b82f6;
            color: white;
        }

        .editor-btn-primary:hover {
            background-color: #2563eb;
        }

        .editor-btn-secondary {
            background-color: #64748b;
            color: white;
        }

        .editor-btn-secondary:hover {
            background-color: #475569;
        }

        .editor-btn-danger {
            background-color: #ef4444;
            color: white;
        }

        .editor-btn-danger:hover {
            background-color: #dc2626;
        }

        .editor-content {
            display: flex;
            flex: 1;
        }

        .editor-sidebar {
            width: 280px;
            background-color: #1e293b;
            border-left: 1px solid #334155;
            padding: 16px;
            overflow-y: auto;
        }

        .sidebar-section {
            margin-bottom: 24px;
        }

        .sidebar-title {
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 12px;
            color: #94a3b8;
        }

        .indicator-template {
            padding: 12px;
            background-color: #334155;
            border-radius: 6px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 13px;
        }

        .indicator-template:hover {
            background-color: #475569;
        }

        .CodeMirror {
            height: 100%;
            font-size: 14px;
        }

        .CodeMirror-scroll {
            overflow: auto !important;
        }

        .CodeMirror-gutters {
            background-color: #111827 !important;
            border-right: 1px solid #334155 !important;
        }

        .CodeMirror-linenumbers {
            padding: 0 8px !important;
        }

        .CodeMirror-guttermarker {
            color: white !important;
        }

        .CodeMirror-guttermarker-subtle {
            color: #d4d4d4 !important;
        }

        .CodeMirror-foldgutter-open, .CodeMirror-foldgutter-folded {
            color: #888 !important;
        }

        .CodeMirror-hints {
            border-radius: 6px !important;
            border: 1px solid #334155 !important;
            background-color: #1e293b !important;
        }

        .CodeMirror-hint {
            padding: 8px 12px !important;
            border-bottom: 1px solid #334155 !important;
        }

        .CodeMirror-hint-active {
            background-color: #3b82f6 !important;
            color: white !important;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="logo-container">
            <img src="https://i.imgur.com/5nHaOsf_d.jpeg?maxwidth=520&shape=thumb&fidelity=high" alt="Quotex Pro" class="logo">
            <div class="platform-title">Quotex Pro</div>
        </div>
        
        <div class="symbol-selector">
            <div class="symbol-header">
                <div class="symbol-title">Symbol</div>
                <div class="add-symbol" id="addSymbol">+</div>
            </div>
            <div class="symbol-list" id="symbolList">
                <div class="symbol-item active" data-symbol="BTC/USD">BTC/USD</div>
                <div class="symbol-item" data-symbol="ETH/USD">ETH/USD</div>
                <div class="symbol-item" data-symbol="XAU/USD">XAU/USD</div>
                <div class="symbol-item" data-symbol="EUR/USD">EUR/USD</div>
                <div class="symbol-item" data-symbol="GBP/USD">GBP/USD</div>
                <div class="symbol-item" data-symbol="USD/JPY">USD/JPY</div>
                <div class="symbol-item" data-symbol="AAPL">AAPL</div>
                <div class="symbol-item" data-symbol="GOOGL">GOOGL</div>
                <div class="symbol-item" data-symbol="TSLA">TSLA</div>
                <div class="symbol-item" data-symbol="MSFT">MSFT</div>
                <div class="symbol-item" data-symbol="AMZN">AMZN</div>
                <div class="symbol-item" data-symbol="NVDA">NVDA</div>
            </div>
            
            <div class="symbol-chips" id="symbolChips">
                <div class="symbol-chip" data-symbol="BTC/USD">
                    BTC/USD
                    <div class="chip-close">×</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div class="main-content">
        <!-- Topbar -->
        <div class="topbar">
            <div class="chart-controls">
                <div class="timeframe-container">
                    <div class="timeframe-display" id="timeframeDisplay">
                        <span id="currentTF">1m</span>
                        <span>▼</span>
                    </div>
                    <div class="timeframe-list" id="timeframeList">
                        <div class="timeframe-option" data-tf="5s">5s</div>
                        <div class="timeframe-option" data-tf="15s">15s</div>
                        <div class="timeframe-option" data-tf="30s">30s</div>
                        <div class="timeframe-option active" data-tf="1m">1m</div>
                        <div class="timeframe-option" data-tf="2m">2m</div>
                        <div class="timeframe-option" data-tf="5m">5m</div>
                        <div class="timeframe-option" data-tf="15m">15m</div>
                        <div class="timeframe-option" data-tf="30m">30m</div>
                        <div class="timeframe-option" data-tf="1h">1h</div>
                        <div class="timeframe-option" data-tf="2h">2h</div>
                        <div class="timeframe-option" data-tf="4h">4h</div>
                        <div class="timeframe-option" data-tf="1d">1d</div>
                    </div>
                </div>
            </div>
            
            <div class="tools-container">
                <div class="tool-btn" id="drawingToolsBtn">✎</div>
                <div class="tool-btn" id="indicatorsBtn">📊</div>
                <div class="tool-btn" id="pineEditorBtn">Pine</div>
            </div>
        </div>
        
        <!-- Chart Container -->
        <div class="chart-container">
            <div class="chart-wrapper">
                <canvas id="chartCanvas" class="chart-canvas"></canvas>
                <div class="chart-overlay" id="chartOverlay"></div>
                
                <div class="chart-legend">
                    <div class="legend-item">Candles: <span id="visibleBars">100</span></div>
                    <div class="legend-item legend-indicator">Indicators: <span id="activeIndicatorsCount">0</span></div>
                </div>
                
                <div class="active-indicators" id="activeIndicators"></div>
                
                <!-- Navigation Controls -->
                <div class="navigation-controls">
                    <div class="nav-btn" id="navLeft">◀️</div>
                    <div class="nav-btn" id="navRight">▶️</div>
                    <div class="nav-btn active" id="autoScroll">🔄</div>
                    <div class="nav-btn" id="resetChart">🗙</div>
                </div>
                
                <div class="zoom-controls">
                    <div class="zoom-btn" id="zoomIn">+</div>
                    <div class="zoom-btn" id="zoomOut">-</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Drawing Tools Panel -->
    <div class="drawing-panel" id="drawingPanel">
        <div class="drawing-tool" data-tool="trend-line" title="Trend Line">╱</div>
        <div class="drawing-tool" data-tool="ray" title="Ray">→</div>
        <div class="drawing-tool" data-tool="extended-line" title="Extended Line">↔</div>
        <div class="drawing-tool" data-tool="horizontal" title="Horizontal Line">—</div>
        <div class="drawing-tool" data-tool="horizontal-ray" title="Horizontal Ray">→</div>
        <div class="drawing-tool" data-tool="vertical" title="Vertical Line">|</div>
        <div class="drawing-tool" data-tool="parallel-channel" title="Parallel Channel">▭</div>
        <div class="drawing-tool" data-tool="rectangle" title="Rectangle">▭</div>
        <div class="drawing-tool" data-tool="ellipse" title="Ellipse">○</div>
        <div class="drawing-tool" data-tool="triangle" title="Triangle">△</div>
        <div class="drawing-tool" data-tool="path" title="Path">✎</div>
        <div class="drawing-tool" data-tool="arrow" title="Arrow">➤</div>
        <div class="drawing-tool" data-tool="text" title="Text">T</div>
        <div class="drawing-tool" data-tool="price-label" title="Price Label">$</div>
        <div class="drawing-tool" data-tool="fib-retracement" title="Fibonacci Retracement">Φ</div>
        <div class="drawing-tool" data-tool="fib-extension" title="Fibonacci Extension">Φ→</div>
        <div class="drawing-tool" data-tool="pitchfork" title="Pitchfork">⌡</div>
        <div class="drawing-tool" data-tool="brush" title="Brush">🖌</div>
        <div class="drawing-tool" data-tool="highlighter" title="Highlighter">🖍</div>
        <div class="drawing-tool" data-tool="measure" title="Measure">📏</div>
        <div class="drawing-tool" data-tool="clear-all" title="Clear All">🗑</div>
    </div>
    
    <!-- Drawing Settings Panel -->
    <div class="drawing-settings" id="drawingSettings">
        <div class="settings-header">
            <div class="settings-title" id="drawingSettingsTitle">Trend Line Settings</div>
            <button class="settings-close" id="closeDrawingSettings">×</button>
        </div>
        
        <div class="form-group">
            <label for="lineColor">Color</label>
            <div class="color-picker">
                <div class="color-option active" style="background-color: #3b82f6;" data-color="#3b82f6"></div>
                <div class="color-option" style="background-color: #10b981;" data-color="#10b981"></div>
                <div class="color-option" style="background-color: #ef4444;" data-color="#ef4444"></div>
                <div class="color-option" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                <div class="color-option" style="background-color: #8b5cf6;" data-color="#8b5cf6"></div>
                <div class="color-option color-custom" data-color="custom"></div>
            </div>
            <div class="form-control custom-color-input" style="display: none; margin-top: 8px;">
                <input type="color" id="customColor" value="#3b82f6">
            </div>
        </div>
        
        <div class="form-group">
            <label for="lineWidth">Line Width</label>
            <input type="range" id="lineWidth" class="form-control" min="1" max="5" value="2">
            <div id="lineWidthValue" style="text-align: right; margin-top: 4px;">2px</div>
        </div>
        
        <div class="form-group">
            <label>Line Style</label>
            <div class="line-style">
                <div class="style-option active" data-style="solid">Solid</div>
                <div class="style-option" data-style="dashed">Dashed</div>
                <div class="style-option" data-style="dotted">Dotted</div>
            </div>
        </div>
        
        <div class="form-group" id="opacityGroup">
            <label for="opacity">Opacity</label>
            <input type="range" id="opacity" class="form-control" min="0" max="1" step="0.1" value="1">
            <div id="opacityValue" style="text-align: right; margin-top: 4px;">100%</div>
        </div>
        
        <div class="form-group" id="fillGroup">
            <label for="fillColor">Fill Color</label>
            <div class="color-picker">
                <div class="color-option active" style="background-color: #3b82f6;" data-color="#3b82f6"></div>
                <div class="color-option" style="background-color: #10b981;" data-color="#10b981"></div>
                <div class="color-option" style="background-color: #ef4444;" data-color="#ef4444"></div>
                <div class="color-option" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                <div class="color-option" style="background-color: #8b5cf6;" data-color="#8b5cf6"></div>
                <div class="color-option color-custom" data-color="custom"></div>
            </div>
            <div class="form-control custom-fill-input" style="display: none; margin-top: 8px;">
                <input type="color" id="customFillColor" value="#3b82f6">
            </div>
        </div>
        
        <div class="form-group" id="textGroup">
            <label for="textValue">Text</label>
            <input type="text" id="textValue" class="form-control" value="Label">
        </div>
        
        <div class="settings-footer">
            <button id="deleteDrawing" class="btn btn-danger">Delete</button>
            <button id="applyDrawingSettings" class="btn btn-primary">Apply</button>
        </div>
    </div>
    
    <!-- Indicators Modal -->
    <div class="indicators-modal" id="indicatorsModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">Indicators</div>
                <button class="modal-close" id="closeIndicatorsModal">×</button>
            </div>
            <div class="modal-body">
                <div class="indicators-categories" id="indicatorsCategories">
                    <div class="category-tab active" data-category="trend">Trend</div>
                    <div class="category-tab" data-category="momentum">Momentum</div>
                    <div class="category-tab" data-category="volume">Volume</div>
                    <div class="category-tab" data-category="volatility">Volatility</div>
                </div>
                
                <div class="indicators-grid" id="indicatorsGrid">
                    <!-- Trend Indicators -->
                    <div class="indicator-item" data-indicator="ma" data-category="trend">
                        <div class="indicator-name">Moving Average (MA)</div>
                        <div class="indicator-desc">Simple moving average</div>
                    </div>
                    <div class="indicator-item" data-indicator="ema" data-category="trend">
                        <div class="indicator-name">Exponential MA (EMA)</div>
                        <div class="indicator-desc">Weighted moving average</div>
                    </div>
                    <div class="indicator-item" data-indicator="wma" data-category="trend">
                        <div class="indicator-name">Weighted MA (WMA)</div>
                        <div class="indicator-desc">Linear weighted average</div>
                    </div>
                    <div class="indicator-item" data-indicator="hma" data-category="trend">
                        <div class="indicator-name">Hull MA (HMA)</div>
                        <div class="indicator-desc">Smoothed moving average</div>
                    </div>
                    <div class="indicator-item" data-indicator="ichimoku" data-category="trend">
                        <div class="indicator-name">Ichimoku Cloud</div>
                        <div class="indicator-desc">Complete trend system</div>
                    </div>
                    <div class="indicator-item" data-indicator="parabolic-sar" data-category="trend">
                        <div class="indicator-name">Parabolic SAR</div>
                        <div class="indicator-desc">Trend reversal points</div>
                    </div>
                    <div class="indicator-item" data-indicator="linear-regression" data-category="trend">
                        <div class="indicator-name">Linear Regression</div>
                        <div class="indicator-desc">Statistical trend line</div>
                    </div>
                    
                    <!-- Momentum Indicators -->
                    <div class="indicator-item" data-indicator="rsi" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Relative Strength Index (RSI)</div>
                        <div class="indicator-desc">Momentum oscillator</div>
                    </div>
                    <div class="indicator-item" data-indicator="macd" data-category="momentum" style="display: none;">
                        <div class="indicator-name">MACD</div>
                        <div class="indicator-desc">Trend & momentum combo</div>
                    </div>
                    <div class="indicator-item" data-indicator="stochastic" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Stochastic Oscillator</div>
                        <div class="indicator-desc">Overbought/oversold levels</div>
                    </div>
                    <div class="indicator-item" data-indicator="stochastic-rsi" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Stochastic RSI</div>
                        <div class="indicator-desc">RSI of RSI</div>
                    </div>
                    <div class="indicator-item" data-indicator="cci" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Commodity Channel Index (CCI)</div>
                        <div class="indicator-desc">Cyclical trend indicator</div>
                    </div>
                    <div class="indicator-item" data-indicator="adx" data-category="momentum" style="display: none;">
                        <div class="indicator-name">ADX</div>
                        <div class="indicator-desc">Trend strength</div>
                    </div>
                    <div class="indicator-item" data-indicator="momentum" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Momentum</div>
                        <div class="indicator-desc">Price change rate</div>
                    </div>
                    <div class="indicator-item" data-indicator="williams-r" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Williams %R</div>
                        <div class="indicator-desc">Momentum indicator</div>
                    </div>
                    <div class="indicator-item" data-indicator="ultimate-oscillator" data-category="momentum" style="display: none;">
                        <div class="indicator-name">Ultimate Oscillator</div>
                        <div class="indicator-desc">Multi-timeframe momentum</div>
                    </div>
                    <div class="indicator-item" data-indicator="roc" data-category="momentum" style="display: none;">
                        <div class="indicator-name">ROC</div>
                        <div class="indicator-desc">Rate of change</div>
                    </div>
                    
                    <!-- Volume Indicators -->
                    <div class="indicator-item" data-indicator="volume" data-category="volume" style="display: none;">
                        <div class="indicator-name">Volume</div>
                        <div class="indicator-desc">Trading volume</div>
                    </div>
                    <div class="indicator-item" data-indicator="obv" data-category="volume" style="display: none;">
                        <div class="indicator-name">On-Balance Volume (OBV)</div>
                        <div class="indicator-desc">Volume flow indicator</div>
                    </div>
                    <div class="indicator-item" data-indicator="ad-line" data-category="volume" style="display: none;">
                        <div class="indicator-name">Accumulation/Distribution</div>
                        <div class="indicator-desc">Volume & price flow</div>
                    </div>
                    <div class="indicator-item" data-indicator="cmf" data-category="volume" style="display: none;">
                        <div class="indicator-name">Chaikin Money Flow (CMF)</div>
                        <div class="indicator-desc">Volume-weighted indicator</div>
                    </div>
                    <div class="indicator-item" data-indicator="mfi" data-category="volume" style="display: none;">
                        <div class="indicator-name">Money Flow Index (MFI)</div>
                        <div class="indicator-desc">Volume-weighted RSI</div>
                    </div>
                    <div class="indicator-item" data-indicator="vwap" data-category="volume" style="display: none;">
                        <div class="indicator-name">VWAP</div>
                        <div class="indicator-desc">Volume weighted price</div>
                    </div>
                    <div class="indicator-item" data-indicator="force-index" data-category="volume" style="display: none;">
                        <div class="indicator-name">Force Index</div>
                        <div class="indicator-desc">Price & volume strength</div>
                    </div>
                    
                    <!-- Volatility Indicators -->
                    <div class="indicator-item" data-indicator="bollinger-bands" data-category="volatility" style="display: none;">
                        <div class="indicator-name">Bollinger Bands</div>
                        <div class="indicator-desc">Volatility bands</div>
                    </div>
                    <div class="indicator-item" data-indicator="atr" data-category="volatility" style="display: none;">
                        <div class="indicator-name">ATR</div>
                        <div class="indicator-desc">Average True Range</div>
                    </div>
                    <div class="indicator-item" data-indicator="keltner-channels" data-category="volatility" style="display: none;">
                        <div class="indicator-name">Keltner Channels</div>
                        <div class="indicator-desc">Volatility-based channels</div>
                    </div>
                    <div class="indicator-item" data-indicator="donchian-channels" data-category="volatility" style="display: none;">
                        <div class="indicator-name">Donchian Channels</div>
                        <div class="indicator-desc">Price range channels</div>
                    </div>
                    <div class="indicator-item" data-indicator="standard-deviation" data-category="volatility" style="display: none;">
                        <div class="indicator-name">Standard Deviation</div>
                        <div class="indicator-desc">Statistical volatility</div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Indicator Settings Modal -->
    <div class="settings-modal" id="settingsModal">
        <div class="settings-content">
            <div class="settings-header">
                <div class="settings-title" id="settingsTitle">Moving Average Settings</div>
                <button class="modal-close" id="closeSettingsModal">×</button>
            </div>
            <div class="settings-body">
                <div class="form-group">
                    <label for="length">Length</label>
                    <input type="number" id="length" class="form-control" value="14" min="1" max="200">
                </div>
                <div class="form-group">
                    <label for="source">Source</label>
                    <select id="source" class="form-control">
                        <option value="close">Close</option>
                        <option value="open">Open</option>
                        <option value="high">High</option>
                        <option value="low">Low</option>
                        <option value="hl2">HL/2</option>
                        <option value="hlc3">HLC/3</option>
                        <option value="ohlc4">OHLC/4</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Color</label>
                    <div class="color-picker">
                        <div class="color-option active" style="background-color: #3b82f6;" data-color="#3b82f6"></div>
                        <div class="color-option" style="background-color: #10b981;" data-color="#10b981"></div>
                        <div class="color-option" style="background-color: #ef4444;" data-color="#ef4444"></div>
                        <div class="color-option" style="background-color: #f59e0b;" data-color="#f59e0b"></div>
                        <div class="color-option" style="background-color: #8b5cf6;" data-color="#8b5cf6"></div>
                        <div class="color-option color-custom" data-color="custom"></div>
                    </div>
                </div>
                <div class="form-group custom-color-input" style="display: none;">
                    <label for="customColor">Custom Color</label>
                    <input type="color" id="customColor" class="form-control" value="#3b82f6">
                </div>
            </div>
            <div class="settings-footer">
                <button id="cancelSettings" class="btn btn-secondary">Cancel</button>
                <button id="applySettings" class="btn btn-primary">Apply</button>
            </div>
        </div>
    </div>

    <!-- Pine Editor -->
    <div class="pine-editor" id="pineEditor">
        <div class="editor-header">
            <div class="editor-title">Pine Script Editor</div>
            <div class="editor-actions">
                <button id="runPine" class="editor-btn editor-btn-primary">Run (F5)</button>
                <button id="savePine" class="editor-btn editor-btn-secondary">Save</button>
                <button id="closePine" class="editor-btn editor-btn-danger">Close (Esc)</button>
            </div>
        </div>
        <div class="editor-content">
            <div class="editor-sidebar">
                <div class="sidebar-section">
                    <div class="sidebar-title">Popular Indicators</div>
                    <div class="indicator-template" data-template="sma">
                        <strong>SMA Crossover</strong>
                        <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">Simple Moving Average strategy with buy/sell signals</div>
                    </div>
                    <div class="indicator-template" data-template="rsi">
                        <strong>RSI Divergence</strong>
                        <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">RSI indicator with overbought/oversold levels</div>
                    </div>
                    <div class="indicator-template" data-template="macd">
                        <strong>MACD Histogram</strong>
                        <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">MACD with histogram and signal line</div>
                    </div>
                    <div class="indicator-template" data-template="bollinger">
                        <strong>Bollinger Bands</strong>
                        <div style="font-size: 12px; margin-top: 4px; opacity: 0.8;">Volatility bands with moving average</div>
                    </div>
                </div>
            </div>
            
            <div class="code-container">
                <div id="codeEditor" style="height: 100%;"></div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/codemirror.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/mode/javascript/javascript.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/matchbrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/edit/closebrackets.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/foldgutter.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/fold/brace-fold.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/show-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/hint/javascript-hint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/selection/active-line.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.2/addon/lint/javascript-lint.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jshint/2.13.6/jshint.min.js"></script>

    <script>
        // Chart Configuration
        const chartCanvas = document.getElementById('chartCanvas');
        const ctx = chartCanvas.getContext('2d');
        const overlay = document.getElementById('chartOverlay');
        
        // State Management
        let state = {
            symbol: 'BTC/USD',
            timeframe: '1m',
            isRunning: true,
            candles: [],
            visibleRange: { start: 0, end: 100 },
            yAxisRange: { min: 0, max: 1 },
            currentPrice: 0,
            selectedTool: null,
            drawing: null,
            drawings: [],
            activeDrawing: null,
            indicators: {},
            activeIndicators: [],
            apiKey: 'secured_api_key_12345',
            simulationInterval: null,
            zoomLevel: 1,
            panOffset: 0,
            autoScroll: true,
            chartPosition: 'center'
        };

        // DOM Elements
        const elements = {
            symbolItems: document.querySelectorAll('.symbol-item'),
            timeframeDisplay: document.getElementById('timeframeDisplay'),
            timeframeList: document.getElementById('timeframeList'),
            timeframeOptions: document.querySelectorAll('.timeframe-option'),
            drawingToolsBtn: document.getElementById('drawingToolsBtn'),
            indicatorsBtn: document.getElementById('indicatorsBtn'),
            pineEditorBtn: document.getElementById('pineEditorBtn'),
            visibleBars: document.getElementById('visibleBars'),
            activeIndicatorsCount: document.getElementById('activeIndicatorsCount'),
            activeIndicators: document.getElementById('activeIndicators'),
            drawingPanel: document.getElementById('drawingPanel'),
            drawingTools: document.querySelectorAll('.drawing-tool'),
            drawingSettings: document.getElementById('drawingSettings'),
            drawingSettingsTitle: document.getElementById('drawingSettingsTitle'),
            closeDrawingSettings: document.getElementById('closeDrawingSettings'),
            lineColorOptions: document.querySelectorAll('.color-picker .color-option'),
            customColor: document.getElementById('customColor'),
            lineWidth: document.getElementById('lineWidth'),
            lineWidthValue: document.getElementById('lineWidthValue'),
            lineStyleOptions: document.querySelectorAll('.line-style .style-option'),
            opacity: document.getElementById('opacity'),
            opacityValue: document.getElementById('opacityValue'),
            fillColorOptions: document.querySelectorAll('#fillGroup .color-picker .color-option'),
            customFillColor: document.getElementById('customFillColor'),
            textValue: document.getElementById('textValue'),
            deleteDrawing: document.getElementById('deleteDrawing'),
            applyDrawingSettings: document.getElementById('applyDrawingSettings'),
            fillGroup: document.getElementById('fillGroup'),
            textGroup: document.getElementById('textGroup'),
            opacityGroup: document.getElementById('opacityGroup'),
            indicatorsModal: document.getElementById('indicatorsModal'),
            indicatorsCategories: document.getElementById('indicatorsCategories'),
            indicatorsGrid: document.getElementById('indicatorsGrid'),
            closeIndicatorsModal: document.getElementById('closeIndicatorsModal'),
            settingsModal: document.getElementById('settingsModal'),
            settingsTitle: document.getElementById('settingsTitle'),
            length: document.getElementById('length'),
            source: document.getElementById('source'),
            colorOptions: document.querySelectorAll('.color-option'),
            customColorInput: document.querySelector('.custom-color-input'),
            customColor: document.getElementById('customColor'),
            closeSettingsModal: document.getElementById('closeSettingsModal'),
            cancelSettings: document.getElementById('cancelSettings'),
            applySettings: document.getElementById('applySettings'),
            pineEditor: document.getElementById('pineEditor'),
            codeEditor: document.getElementById('codeEditor'),
            runPine: document.getElementById('runPine'),
            savePine: document.getElementById('savePine'),
            closePine: document.getElementById('closePine'),
            addSymbol: document.getElementById('addSymbol'),
            symbolList: document.getElementById('symbolList'),
            currentTF: document.getElementById('currentTF'),
            symbolChips: document.getElementById('symbolChips'),
            navLeft: document.getElementById('navLeft'),
            navRight: document.getElementById('navRight'),
            autoScroll: document.getElementById('autoScroll'),
            resetChart: document.getElementById('resetChart'),
            zoomIn: document.getElementById('zoomIn'),
            zoomOut: document.getElementById('zoomOut')
        };

        // Initialize CodeMirror
        let codeMirror;
        function initCodeMirror() {
            codeMirror = CodeMirror(elements.codeEditor, {
                value: `// Pine Script - Moving Average Crossover
// @version=5
indicator("MA Crossover", overlay=true)

// Input parameters
ma_fast_length = input.int(9, "Fast MA Length")
ma_slow_length = input.int(21, "Slow MA Length")
ma_type = input.string("EMA", "MA Type", options=["SMA", "EMA", "WMA"])

// Calculate moving averages
ma_fast = request.security(syminfo.tickerid, timeframe.period, 
    ma_type == "SMA" ? ta.sma(close, ma_fast_length) : 
    ma_type == "EMA" ? ta.ema(close, ma_fast_length) : 
    ta.wma(close, ma_fast_length))

ma_slow = request.security(syminfo.tickerid, timeframe.period, 
    ma_type == "SMA" ? ta.sma(close, ma_slow_length) : 
    ma_type == "EMA" ? ta.ema(close, ma_slow_length) : 
    ta.wma(close, ma_slow_length))

// Plot moving averages
plot(ma_fast, "Fast MA", color=color.blue)
plot(ma_slow, "Slow MA", color=color.red)

// Generate signals
buy_signal = ta.crossover(ma_fast, ma_slow)
sell_signal = ta.crossunder(ma_fast, ma_slow)

// Plot signals
plotshape(buy_signal, title="Buy Signal", location=location.belowbar, 
         color=color.green, style=shape.triangleup, size=size.small)
plotshape(sell_signal, title="Sell Signal", location=location.abovebar, 
         color=color.red, style=shape.triangledown, size=size.small)

// Strategy execution
if (buy_signal)
    strategy.entry("Buy", strategy.long)

if (sell_signal)
    strategy.entry("Sell", strategy.short)`,
                mode: "javascript",
                theme: "monokai",
                lineNumbers: true,
                matchBrackets: true,
                autoCloseBrackets: true,
                styleActiveLine: true,
                foldGutter: true,
                gutters: ["CodeMirror-linenumbers", "CodeMirror-foldgutter"],
                extraKeys: {
                    "Ctrl-Space": "autocomplete",
                    "F5": function(cm) { executePineScript(); },
                    "Esc": function(cm) { elements.pineEditor.style.display = 'none'; }
                }
            });

            // Add linting
            codeMirror.setOption("lint", true);
        }

        // Utility Functions
        function getTimeframeInMs(tf) {
            const map = { 
                '5s': 5000, '15s': 15000, '30s': 30000, '1m': 60000, '2m': 120000, '5m': 300000,
                '15m': 900000, '30m': 1800000, '1h': 3600000, '2h': 7200000, '4h': 14400000,
                '1d': 86400000
            };
            return map[tf] || 60000;
        }

        function generateInitialCandles(symbol, timeframe) {
            const now = Date.now();
            const interval = getTimeframeInMs(timeframe);
            const candlesData = [];
            let price = 50000 + Math.random() * 10000;
            
            for (let i = 200; i >= 0; i--) {
                const time = now - (i * interval);
                const volatility = price * 0.02;
                const change = (Math.random() - 0.5) * volatility * 2;
                const open = price;
                const close = price + change;
                const high = Math.max(open, close) + Math.random() * volatility * 0.5;
                const low = Math.min(open, close) - Math.random() * volatility * 0.5;
                const volume = 100 + Math.random() * 200;
                
                candlesData.push({ time, open, high, low, close, volume, symbol });
                price = close;
            }
            
            return candlesData;
        }

        function calculateIndicator(data, type, params = {}) {
            if (data.length < params.length) return [];
            
            const source = params.source === 'close' ? data.map(c => c.close) :
                          params.source === 'open' ? data.map(c => c.open) :
                          params.source === 'high' ? data.map(c => c.high) :
                          params.source === 'low' ? data.map(c => c.low) :
                          params.source === 'hl2' ? data.map(c => (c.high + c.low) / 2) :
                          params.source === 'hlc3' ? data.map(c => (c.high + c.low + c.close) / 3) :
                          data.map(c => (c.open + c.high + c.low + c.close) / 4);
            
            switch (type) {
                case 'ma':
                    return source.map((_, index) => {
                        if (index < params.length - 1) return null;
                        const sum = source.slice(index - params.length + 1, index + 1).reduce((acc, val) => acc + val, 0);
                        return sum / params.length;
                    });
                
                case 'ema':
                    const multiplier = 2 / (params.length + 1);
                    return source.map((_, index) => {
                        if (index < params.length - 1) return null;
                        if (index === params.length - 1) return source.slice(0, params.length).reduce((acc, val) => acc + val, 0) / params.length;
                        
                        const prevEMA = calculateIndicator(data.slice(0, index), 'ema', params)[params.length - 2];
                        return (source[index] - prevEMA) * multiplier + prevEMA;
                    });
                
                case 'rsi':
                    return source.map((_, index) => {
                        if (index < params.length) return null;
                        const gains = [];
                        const losses = [];
                        
                        for (let i = index - params.length + 1; i <= index; i++) {
                            const change = source[i] - source[i-1];
                            gains.push(Math.max(change, 0));
                            losses.push(Math.max(-change, 0));
                        }
                        
                        const avgGain = gains.reduce((a, b) => a + b, 0) / params.length;
                        const avgLoss = losses.reduce((a, b) => a + b, 0) / params.length;
                        
                        if (avgLoss === 0) return 100;
                        const rs = avgGain / avgLoss;
                        return 100 - (100 / (1 + rs));
                    });
                
                case 'macd':
                    const fastEMA = calculateIndicator(data, 'ema', { ...params, length: 12 });
                    const slowEMA = calculateIndicator(data, 'ema', { ...params, length: 26 });
                    const macdLine = fastEMA.map((val, i) => val !== null && slowEMA[i] !== null ? val - slowEMA[i] : null);
                    const signalLine = calculateIndicator(data.map((_, i) => ({ close: macdLine[i] })), 'ema', { ...params, length: 9 });
                    const histogram = macdLine.map((val, i) => val !== null && signalLine[i] !== null ? val - signalLine[i] : null);
                    
                    return { macdLine, signalLine, histogram };
                
                default:
                    return [];
            }
        }

        // Chart Rendering
        function resizeCanvas() {
            const container = chartCanvas.parentElement;
            const dpi = window.devicePixelRatio;
            
            chartCanvas.width = container.clientWidth * dpi;
            chartCanvas.height = container.clientHeight * dpi;
            ctx.scale(dpi, dpi);
            
            chartCanvas.style.width = container.clientWidth + 'px';
            chartCanvas.style.height = container.clientHeight + 'px';
        }

        function renderChart() {
            if (!state.candles.length) return;
            
            const container = chartCanvas.parentElement;
            const width = container.clientWidth;
            const height = container.clientHeight;
            const visibleCandles = state.candles.slice(state.visibleRange.start, state.visibleRange.end + 1);
            
            if (!visibleCandles.length) return;
            
            // Clear canvas
            ctx.clearRect(0, 0, width, height);
            
            const candleWidth = Math.max(2, Math.min(12, width / visibleCandles.length));
            const gap = 1;
            const actualWidth = candleWidth - gap;
            
            const priceToY = (price) => {
                const range = state.yAxisRange.max - state.yAxisRange.min;
                return height - ((price - state.yAxisRange.min) / range) * height;
            };
            
            const timeToX = (index) => {
                return (index * candleWidth);
            };
            
            // Grid lines
            for (let i = 0; i < 8; i++) {
                const y = (i / 7) * height;
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(width, y);
                ctx.strokeStyle = '#1e293b';
                ctx.lineWidth = 0.5;
                ctx.globalAlpha = 0.3;
                ctx.stroke();
                ctx.globalAlpha = 1;
            }
            
            // Price labels
            for (let i = 0; i < 6; i++) {
                const y = (i / 5) * height;
                const price = state.yAxisRange.max - (i / 5) * (state.yAxisRange.max - state.yAxisRange.min);
                ctx.fillStyle = '#94a3b8';
                ctx.font = '11px Arial';
                ctx.textAlign = 'right';
                ctx.fillText(price.toFixed(2), width - 8, y + 4);
            }
            
            // Time labels
            const labelInterval = Math.max(1, Math.floor(visibleCandles.length / 6));
            for (let i = 0; i < visibleCandles.length; i += labelInterval) {
                const x = timeToX(i) + actualWidth / 2;
                const date = new Date(visibleCandles[i].time);
                const timeStr = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                ctx.fillStyle = '#94a3b8';
                ctx.font = '10px Arial';
                ctx.textAlign = 'center';
                ctx.fillText(timeStr, x, height - 8);
            }
            
            // Candles
            visibleCandles.forEach((candle, index) => {
                const x = timeToX(index);
                const openY = priceToY(candle.open);
                const closeY = priceToY(candle.close);
                const highY = priceToY(candle.high);
                const lowY = priceToY(candle.low);
                const isUp = candle.close >= candle.open;
                const color = isUp ? '#10b981' : '#ef4444';
                
                // Wick
                ctx.beginPath();
                ctx.moveTo(x + actualWidth / 2, highY);
                ctx.lineTo(x + actualWidth / 2, lowY);
                ctx.strokeStyle = isUp ? '#059669' : '#dc2626';
                ctx.lineWidth = 1;
                ctx.stroke();
                
                // Body
                ctx.fillStyle = color;
                ctx.strokeStyle = isUp ? '#059669' : '#dc2626';
                ctx.lineWidth = 1;
                ctx.fillRect(x, Math.min(openY, closeY), actualWidth, Math.max(2, Math.abs(closeY - openY)));
                ctx.strokeRect(x, Math.min(openY, closeY), actualWidth, Math.max(2, Math.abs(closeY - openY)));
            });
            
            // Render all active indicators
            Object.keys(state.indicators).forEach(key => {
                const indicator = state.indicators[key];
                if (indicator.enabled) {
                    renderIndicator(indicator, visibleCandles, width, height, priceToY, timeToX);
                }
            });
            
            // Render drawings
            renderDrawings(width, height, priceToY, timeToX);
            
            // Update legend
            elements.visibleBars.textContent = visibleCandles.length;
            elements.activeIndicatorsCount.textContent = Object.keys(state.indicators).filter(key => state.indicators[key].enabled).length;
        }

        function renderIndicator(indicator, visibleCandles, width, height, priceToY, timeToX) {
            const data = state.candles;
            const params = indicator.params;
            
            switch (indicator.type) {
                case 'ma':
                case 'ema':
                    const values = calculateIndicator(data, indicator.type, params);
                    ctx.strokeStyle = params.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    
                    let firstPoint = true;
                    values.slice(state.visibleRange.start, state.visibleRange.end + 1).forEach((value, index) => {
                        if (!value) return;
                        const x = timeToX(index) + actualWidth / 2;
                        const y = priceToY(value);
                        
                        if (firstPoint) {
                            ctx.moveTo(x, y);
                            firstPoint = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    
                    ctx.stroke();
                    break;
                
                case 'rsi':
                    // RSI is rendered in a separate panel
                    break;
                
                case 'macd':
                    const macdData = calculateIndicator(data, 'macd', params);
                    const zeroLine = height * 0.8;
                    
                    // MACD line
                    ctx.strokeStyle = params.color;
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    let firstPoint1 = true;
                    macdData.macdLine.slice(state.visibleRange.start, state.visibleRange.end + 1).forEach((value, index) => {
                        if (!value) return;
                        const x = timeToX(index) + actualWidth / 2;
                        const y = zeroLine - value * 100; // Scale factor
                        if (firstPoint1) {
                            ctx.moveTo(x, y);
                            firstPoint1 = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                    
                    // Signal line
                    ctx.strokeStyle = '#ff6b6b';
                    ctx.lineWidth = 1;
                    ctx.beginPath();
                    let firstPoint2 = true;
                    macdData.signalLine.slice(state.visibleRange.start, state.visibleRange.end + 1).forEach((value, index) => {
                        if (!value) return;
                        const x = timeToX(index) + actualWidth / 2;
                        const y = zeroLine - value * 100;
                        if (firstPoint2) {
                            ctx.moveTo(x, y);
                            firstPoint2 = false;
                        } else {
                            ctx.lineTo(x, y);
                        }
                    });
                    ctx.stroke();
                    
                    // Histogram
                    macdData.histogram.slice(state.visibleRange.start, state.visibleRange.end + 1).forEach((value, index) => {
                        if (!value) return;
                        const x = timeToX(index);
                        const y = zeroLine - value * 100;
                        const height = Math.abs(value) * 100;
                        ctx.fillStyle = value > 0 ? '#4ade80' : '#ef4444';
                        ctx.fillRect(x, y, actualWidth, height);
                    });
                    break;
            }
        }

        function renderDrawings(width, height, priceToY, timeToX) {
            state.drawings.forEach(drawing => {
                ctx.save();
                ctx.globalAlpha = drawing.opacity || 1;
                
                switch (drawing.type) {
                    case 'trend-line':
                        renderTrendLine(drawing, priceToY, timeToX);
                        break;
                    case 'horizontal':
                        renderHorizontalLine(drawing, priceToY, timeToX);
                        break;
                    case 'vertical':
                        renderVerticalLine(drawing, priceToY, timeToX);
                        break;
                    case 'rectangle':
                        renderRectangle(drawing, priceToY, timeToX);
                        break;
                    case 'ellipse':
                        renderEllipse(drawing, priceToY, timeToX);
                        break;
                    case 'fib-retracement':
                        renderFibonacciRetracement(drawing, priceToY, timeToX);
                        break;
                    case 'arrow':
                        renderArrow(drawing, priceToY, timeToX);
                        break;
                    case 'text':
                        renderText(drawing, priceToY, timeToX);
                        break;
                }
                
                ctx.restore();
            });
        }

        function renderTrendLine(drawing, priceToY, timeToX) {
            const x1 = timeToX(drawing.points[0].index);
            const y1 = priceToY(drawing.points[0].price);
            const x2 = timeToX(drawing.points[1].index);
            const y2 = priceToY(drawing.points[1].price);
            
            ctx.strokeStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            
            if (drawing.style === 'dashed') {
                ctx.setLineDash([5, 5]);
            } else if (drawing.style === 'dotted') {
                ctx.setLineDash([2, 3]);
            }
            
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        function renderHorizontalLine(drawing, priceToY, timeToX) {
            const y = priceToY(drawing.price);
            const x1 = 0;
            const x2 = chartCanvas.width;
            
            ctx.strokeStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            
            if (drawing.style === 'dashed') {
                ctx.setLineDash([5, 5]);
            } else if (drawing.style === 'dotted') {
                ctx.setLineDash([2, 3]);
            }
            
            ctx.beginPath();
            ctx.moveTo(x1, y);
            ctx.lineTo(x2, y);
            ctx.stroke();
            
            // Add text label
            if (drawing.text) {
                ctx.fillStyle = drawing.color;
                ctx.font = '12px Arial';
                ctx.textAlign = 'left';
                ctx.fillText(drawing.text, 8, y - 4);
            }
            
            ctx.setLineDash([]);
        }

        function renderVerticalLine(drawing, priceToY, timeToX) {
            const x = timeToX(drawing.index);
            const y1 = 0;
            const y2 = chartCanvas.height;
            
            ctx.strokeStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            
            if (drawing.style === 'dashed') {
                ctx.setLineDash([5, 5]);
            } else if (drawing.style === 'dotted') {
                ctx.setLineDash([2, 3]);
            }
            
            ctx.beginPath();
            ctx.moveTo(x, y1);
            ctx.lineTo(x, y2);
            ctx.stroke();
            
            ctx.setLineDash([]);
        }

        function renderRectangle(drawing, priceToY, timeToX) {
            const x1 = timeToX(drawing.points[0].index);
            const y1 = priceToY(drawing.points[0].price);
            const x2 = timeToX(drawing.points[1].index);
            const y2 = priceToY(drawing.points[1].price);
            const x = Math.min(x1, x2);
            const y = Math.min(y1, y2);
            const width = Math.abs(x2 - x1);
            const height = Math.abs(y2 - y1);
            
            // Fill
            if (drawing.fillColor) {
                ctx.fillStyle = drawing.fillColor;
                ctx.fillRect(x, y, width, height);
            }
            
            // Stroke
            ctx.strokeStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            ctx.strokeRect(x, y, width, height);
        }

        function renderEllipse(drawing, priceToY, timeToX) {
            const x1 = timeToX(drawing.points[0].index);
            const y1 = priceToY(drawing.points[0].price);
            const x2 = timeToX(drawing.points[1].index);
            const y2 = priceToY(drawing.points[1].price);
            const x = (x1 + x2) / 2;
            const y = (y1 + y2) / 2;
            const radiusX = Math.abs(x2 - x1) / 2;
            const radiusY = Math.abs(y2 - y1) / 2;
            
            ctx.beginPath();
            ctx.ellipse(x, y, radiusX, radiusY, 0, 0, 2 * Math.PI);
            
            // Fill
            if (drawing.fillColor) {
                ctx.fillStyle = drawing.fillColor;
                ctx.fill();
            }
            
            // Stroke
            ctx.strokeStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            ctx.stroke();
        }

        function renderFibonacciRetracement(drawing, priceToY, timeToX) {
            const x1 = timeToX(drawing.points[0].index);
            const y1 = priceToY(drawing.points[0].price);
            const x2 = timeToX(drawing.points[1].index);
            const y2 = priceToY(drawing.points[1].price);
            const levels = [0, 0.236, 0.382, 0.5, 0.618, 0.786, 1];
            
            levels.forEach(level => {
                const y = y1 + (y2 - y1) * level;
                
                ctx.strokeStyle = drawing.color;
                ctx.lineWidth = drawing.width;
                ctx.setLineDash([5, 5]);
                
                ctx.beginPath();
                ctx.moveTo(0, y);
                ctx.lineTo(chartCanvas.width, y);
                ctx.stroke();
                
                // Level label
                ctx.fillStyle = drawing.color;
                ctx.font = '11px Arial';
                ctx.textAlign = 'left';
                ctx.fillText((level * 100).toFixed(1) + '%', 8, y - 4);
            });
            
            ctx.setLineDash([]);
        }

        function renderArrow(drawing, priceToY, timeToX) {
            const x1 = timeToX(drawing.points[0].index);
            const y1 = priceToY(drawing.points[0].price);
            const x2 = timeToX(drawing.points[1].index);
            const y2 = priceToY(drawing.points[1].price);
            
            const headLength = 10;
            const angle = Math.atan2(y2 - y1, x2 - x1);
            
            ctx.strokeStyle = drawing.color;
            ctx.fillStyle = drawing.color;
            ctx.lineWidth = drawing.width;
            
            // Line
            ctx.beginPath();
            ctx.moveTo(x1, y1);
            ctx.lineTo(x2, y2);
            ctx.stroke();
            
            // Arrowhead
            ctx.beginPath();
            ctx.moveTo(x2, y2);
            ctx.lineTo(x2 - headLength * Math.cos(angle - Math.PI / 6), y2 - headLength * Math.sin(angle - Math.PI / 6));
            ctx.lineTo(x2 - headLength * Math.cos(angle + Math.PI / 6), y2 - headLength * Math.sin(angle + Math.PI / 6));
            ctx.closePath();
            ctx.fill();
        }

        function renderText(drawing, priceToY, timeToX) {
            const x = timeToX(drawing.index);
            const y = priceToY(drawing.price);
            
            // Background
            if (drawing.bgColor) {
                ctx.fillStyle = drawing.bgColor;
                const textWidth = ctx.measureText(drawing.text).width;
                ctx.fillRect(x - 4, y - 16, textWidth + 8, 20);
            }
            
            // Text
            ctx.fillStyle = drawing.color || '#ffffff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'left';
            ctx.fillText(drawing.text, x, y);
        }

        // Drawing Functions
        function startDrawing(type, x, y) {
            const container = chartCanvas.parentElement;
            const rect = chartCanvas.getBoundingClientRect();
            const chartX = x - rect.left;
            const chartY = y - rect.top;
            
            const timeIndex = Math.floor(chartX / (container.clientWidth / state.candles.length));
            const price = yToPrice(chartY);
            
            state.drawing = {
                type: type,
                points: [{ index: timeIndex, price: price }],
                color: '#3b82f6',
                width: 2,
                style: 'solid',
                opacity: 1
            };
            
            // Special cases
            if (type === 'horizontal') {
                state.drawing.price = price;
            } else if (type === 'vertical') {
                state.drawing.index = timeIndex;
            } else if (type === 'text') {
                state.drawing.index = timeIndex;
                state.drawing.price = price;
                state.drawing.text = 'Label';
                state.drawing.bgColor = '#000000';
            }
        }

        function updateDrawing(x, y) {
            if (!state.drawing) return;
            
            const container = chartCanvas.parentElement;
            const rect = chartCanvas.getBoundingClientRect();
            const chartX = x - rect.left;
            const chartY = y - rect.top;
            
            const timeIndex = Math.floor(chartX / (container.clientWidth / state.candles.length));
            const price = yToPrice(chartY);
            
            if (state.drawing.type === 'horizontal') {
                state.drawing.price = price;
            } else if (state.drawing.type === 'vertical') {
                state.drawing.index = timeIndex;
            } else if (state.drawing.type === 'text') {
                state.drawing.index = timeIndex;
                state.drawing.price = price;
            } else {
                // For multi-point drawings
                if (state.drawing.points.length === 1) {
                    state.drawing.points.push({ index: timeIndex, price: price });
                } else {
                    state.drawing.points[1] = { index: timeIndex, price: price };
                }
            }
            
            renderChart();
        }

        function finishDrawing(x, y) {
            if (!state.drawing) return;
            
            // If it's a single-point drawing, we already have all data
            if (['horizontal', 'vertical', 'text'].includes(state.drawing.type)) {
                state.drawings.push(state.drawing);
            } 
            // For multi-point drawings, ensure we have two points
            else if (state.drawing.points.length === 2) {
                state.drawings.push(state.drawing);
            }
            
            state.drawing = null;
            renderChart();
        }

        function yToPrice(y) {
            const container = chartCanvas.parentElement;
            const height = container.clientHeight;
            const range = state.yAxisRange.max - state.yAxisRange.min;
            return state.yAxisRange.max - (y / height) * range;
        }

        function priceToY(price) {
            const container = chartCanvas.parentElement;
            const height = container.clientHeight;
            const range = state.yAxisRange.max - state.yAxisRange.min;
            return height - ((price - state.yAxisRange.min) / range) * height;
        }

        // Event Listeners
        window.addEventListener('resize', () => {
            resizeCanvas();
            renderChart();
        });

        chartCanvas.addEventListener('wheel', (e) => {
            e.preventDefault();
            const rect = chartCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const chartWidth = rect.width;
            
            const zoomFactor = e.deltaY > 0 ? 0.9 : 1.1;
            const currentLength = state.visibleRange.end - state.visibleRange.start + 1;
            const newLength = Math.max(50, Math.min(500, Math.round(currentLength * zoomFactor)));
            
            const relativePos = x / chartWidth;
            const centerIndex = Math.round(state.visibleRange.start + relativePos * currentLength);
            
            const newStart = Math.max(0, centerIndex - Math.round(newLength * relativePos));
            const newEnd = Math.min(state.candles.length - 1, newStart + newLength - 1);
            
            state.visibleRange = { start: newStart, end: newEnd };
            
            updateYAxisRange();
            renderChart();
        });

        let isDragging = false;
        let startX = 0;
        let startStart = 0;

        chartCanvas.addEventListener('mousedown', (e) => {
            const rect = chartCanvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            if (!state.selectedTool) {
                isDragging = true;
                startX = x;
                startStart = state.visibleRange.start;
                chartCanvas.style.cursor = 'grabbing';
            } else {
                startDrawing(state.selectedTool, e.clientX, e.clientY);
            }
        });

        document.addEventListener('mousemove', (e) => {
            if (isDragging) {
                const rect = chartCanvas.getBoundingClientRect();
                const deltaX = e.clientX - rect.left - startX;
                const pixelsPerCandle = (rect.width) / (state.visibleRange.end - state.visibleRange.start + 1);
                const candleShift = Math.round(deltaX / pixelsPerCandle);
                
                const newStart = Math.max(0, startStart - candleShift);
                const newEnd = Math.min(state.candles.length - 1, newStart + (state.visibleRange.end - state.visibleRange.start));
                
                state.visibleRange = { start: newStart, end: newEnd };
                renderChart();
            }
            
            if (state.drawing) {
                updateDrawing(e.clientX, e.clientY);
            }
        });

        document.addEventListener('mouseup', (e) => {
            if (isDragging) {
                isDragging = false;
                chartCanvas.style.cursor = 'grab';
            }
            
            if (state.drawing) {
                finishDrawing(e.clientX, e.clientY);
            }
        });

        // UI Event Listeners
        elements.symbolItems.forEach(item => {
            item.addEventListener('click', () => {
                const symbol = item.dataset.symbol;
                
                // Add symbol chip if not already exists
                if (!document.querySelector(`.symbol-chip[data-symbol="${symbol}"]`)) {
                    const chip = document.createElement('div');
                    chip.className = 'symbol-chip';
                    chip.dataset.symbol = symbol;
                    chip.innerHTML = `
                        ${symbol}
                        <div class="chip-close">×</div>
                    `;
                    elements.symbolChips.appendChild(chip);
                    
                    // Add close event
                    chip.querySelector('.chip-close').addEventListener('click', (e) => {
                        e.stopPropagation();
                        chip.remove();
                        if (elements.symbolChips.children.length === 0) {
                            addDefaultSymbol();
                        }
                    });
                    
                    // Add click event to switch chart
                    chip.addEventListener('click', () => {
                        state.symbol = symbol;
                        state.candles = generateInitialCandles(symbol, state.timeframe);
                        resetChart();
                    });
                }
                
                // Reset active state
                document.querySelectorAll('.symbol-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                elements.symbolList.classList.add('hidden');
                
                // Switch to this symbol
                state.symbol = symbol;
                state.candles = generateInitialCandles(symbol, state.timeframe);
                resetChart();
            });
        });

        function addDefaultSymbol() {
            const chip = document.createElement('div');
            chip.className = 'symbol-chip';
            chip.dataset.symbol = 'BTC/USD';
            chip.innerHTML = `
                BTC/USD
                <div class="chip-close">×</div>
            `;
            elements.symbolChips.appendChild(chip);
            
            // Add close event
            chip.querySelector('.chip-close').addEventListener('click', (e) => {
                e.stopPropagation();
                chip.remove();
                if (elements.symbolChips.children.length === 0) {
                    addDefaultSymbol();
                }
            });
            
            // Add click event
            chip.addEventListener('click', () => {
                state.symbol = 'BTC/USD';
                state.candles = generateInitialCandles('BTC/USD', state.timeframe);
                resetChart();
            });
        }

        elements.addSymbol.addEventListener('click', (e) => {
            e.stopPropagation();
            elements.symbolList.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.symbol-selector')) {
                elements.symbolList.classList.add('hidden');
            }
        });

        // Timeframe selection
        elements.timeframeOptions.forEach(option => {
            option.addEventListener('click', () => {
                document.querySelectorAll('.timeframe-option').forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                state.timeframe = option.dataset.tf;
                elements.currentTF.textContent = state.timeframe;
                elements.timeframeList.classList.add('hidden');
                
                // Update all symbol charts
                state.candles = generateInitialCandles(state.symbol, state.timeframe);
                resetChart();
            });
        });

        elements.timeframeDisplay.addEventListener('click', () => {
            elements.timeframeList.classList.toggle('hidden');
        });

        document.addEventListener('click', (e) => {
            if (!e.target.closest('.timeframe-container')) {
                elements.timeframeList.classList.add('hidden');
            }
        });

        // Drawing Tools
        elements.drawingTools.forEach(tool => {
            tool.addEventListener('click', () => {
                const toolType = tool.dataset.tool;
                
                // Clear active state from all tools
                elements.drawingTools.forEach(t => t.classList.remove('active'));
                
                // If clicking the same tool, deactivate it
                if (state.selectedTool === toolType) {
                    state.selectedTool = null;
                    chartCanvas.style.cursor = 'grab';
                } else {
                    // Activate the tool
                    state.selectedTool = toolType;
                    tool.classList.add('active');
                    chartCanvas.style.cursor = 'crosshair';
                }
            });
        });

        // Drawing Settings
        elements.closeDrawingSettings.addEventListener('click', () => {
            elements.drawingSettings.style.display = 'none';
        });

        elements.lineWidth.addEventListener('input', () => {
            elements.lineWidthValue.textContent = `${elements.lineWidth.value}px`;
        });

        elements.opacity.addEventListener('input', () => {
            elements.opacityValue.textContent = `${Math.round(elements.opacity.value * 100)}%`;
        });

        // Color pickers
        elements.lineColorOptions.forEach(option => {
            option.addEventListener('click', () => {
                elements.lineColorOptions.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                
                if (option.dataset.color === 'custom') {
                    document.querySelector('#customColor').parentElement.style.display = 'block';
                } else {
                    document.querySelector('#customColor').parentElement.style.display = 'none';
                }
            });
        });

        elements.fillColorOptions.forEach(option => {
            option.addEventListener('click', () => {
                elements.fillColorOptions.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
                
                if (option.dataset.color === 'custom') {
                    document.querySelector('#customFillColor').parentElement.style.display = 'block';
                } else {
                    document.querySelector('#customFillColor').parentElement.style.display = 'none';
                }
            });
        });

        elements.lineStyleOptions.forEach(option => {
            option.addEventListener('click', () => {
                elements.lineStyleOptions.forEach(o => o.classList.remove('active'));
                option.classList.add('active');
            });
        });

        // Navigation Controls
        elements.navLeft.addEventListener('click', () => {
            const shift = Math.floor((state.visibleRange.end - state.visibleRange.start) * 0.3);
            const newStart = Math.max(0, state.visibleRange.start - shift);
            const newEnd = Math.min(state.candles.length - 1, state.visibleRange.end - shift);
            
            state.visibleRange = { start: newStart, end: newEnd };
            state.autoScroll = false;
            elements.autoScroll.classList.remove('active');
            renderChart();
        });

        elements.navRight.addEventListener('click', () => {
            const shift = Math.floor((state.visibleRange.end - state.visibleRange.start) * 0.3);
            const newStart = Math.min(state.candles.length - (state.visibleRange.end - state.visibleRange.start + 1), state.visibleRange.start + shift);
            const newEnd = Math.min(state.candles.length - 1, state.visibleRange.end + shift);
            
            state.visibleRange = { start: newStart, end: newEnd };
            state.autoScroll = false;
            elements.autoScroll.classList.remove('active');
            renderChart();
        });

        elements.autoScroll.addEventListener('click', () => {
            state.autoScroll = !state.autoScroll;
            elements.autoScroll.classList.toggle('active', state.autoScroll);
            
            if (state.autoScroll) {
                state.visibleRange = {
                    start: Math.max(0, state.candles.length - 100),
                    end: state.candles.length - 1
                };
                renderChart();
            }
        });

        elements.resetChart.addEventListener('click', () => {
            state.visibleRange = {
                start: Math.max(0, state.candles.length - 100),
                end: state.candles.length - 1
            };
            state.autoScroll = true;
            elements.autoScroll.classList.add('active');
            renderChart();
        });

        elements.zoomIn.addEventListener('click', () => {
            const currentLength = state.visibleRange.end - state.visibleRange.start + 1;
            const newLength = Math.max(10, Math.floor(currentLength * 0.8));
            
            const center = Math.round((state.visibleRange.start + state.visibleRange.end) / 2);
            const half = Math.floor(newLength / 2);
            
            const newStart = Math.max(0, center - half);
            const newEnd = Math.min(state.candles.length - 1, center + half);
            
            state.visibleRange = { start: newStart, end: newEnd };
            state.autoScroll = false;
            elements.autoScroll.classList.remove('active');
            renderChart();
        });

        elements.zoomOut.addEventListener('click', () => {
            const currentLength = state.visibleRange.end - state.visibleRange.start + 1;
            const newLength = Math.min(500, Math.floor(currentLength * 1.25));
            
            const center = Math.round((state.visibleRange.start + state.visibleRange.end) / 2);
            const half = Math.floor(newLength / 2);
            
            const newStart = Math.max(0, center - half);
            const newEnd = Math.min(state.candles.length - 1, center + half);
            
            state.visibleRange = { start: newStart, end: newEnd };
            state.autoScroll = false;
            elements.autoScroll.classList.remove('active');
            renderChart();
        });

        // Initialize Functions
        function updateYAxisRange() {
            const visibleCandles = state.candles.slice(state.visibleRange.start, state.visibleRange.end + 1);
            if (visibleCandles.length === 0) return;
            
            const prices = visibleCandles.flatMap(c => [c.high, c.low]);
            const min = Math.min(...prices) * 0.99;
            const max = Math.max(...prices) * 1.01;
            
            // Hysteresis to prevent constant rescaling
            const range = state.yAxisRange.max - state.yAxisRange.min;
            const lowerBand = state.yAxisRange.min + range * 0.1;
            const upperBand = state.yAxisRange.max - range * 0.1;
            
            if (min < lowerBand || max > upperBand) {
                state.yAxisRange = { min, max };
            }
        }

        function updateActiveIndicators() {
            elements.activeIndicators.innerHTML = '';
            Object.keys(state.indicators).forEach(key => {
                if (state.indicators[key].enabled) {
                    const div = document.createElement('div');
                    div.className = 'active-indicator';
                    const name = key.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
                    div.innerHTML = `
                        <span>${name}</span>
                        <div class="indicator-close" data-indicator="${key}">×</div>
                    `;
                    elements.activeIndicators.appendChild(div);
                }
            });
            
            // Add event listeners to close buttons
            document.querySelectorAll('.indicator-close').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    const indicator = e.target.dataset.indicator;
                    state.indicators[indicator].enabled = false;
                    updateActiveIndicators();
                    renderChart();
                });
            });
        }

        function resetChart() {
            state.candles = generateInitialCandles(state.symbol, state.timeframe);
            state.currentPrice = state.candles[state.candles.length - 1].close;
            
            updateYAxisRange();
            
            state.visibleRange = {
                start: Math.max(0, state.candles.length - 100),
                end: state.candles.length - 1
            };
            
            renderChart();
            updateActiveIndicators();
        }

        // Auto-update simulation
        function startSimulation() {
            if (state.simulationInterval) clearInterval(state.simulationInterval);
            
            const interval = getTimeframeInMs(state.timeframe) / 2;
            state.simulationInterval = setInterval(() => {
                if (state.candles.length === 0) return;
                
                const last = state.candles[state.candles.length - 1];
                const volatility = last.close * 0.01;
                const change = (Math.random() - 0.5) * volatility * 2;
                const open = last.close;
                const close = open + change;
                const high = Math.max(open, close) + Math.random() * volatility * 0.3;
                const low = Math.min(open, close) - Math.random() * volatility * 0.3;
                const volume = 100 + Math.random() * 200;
                
                const newCandle = { 
                    time: Date.now(), 
                    open, 
                    high, 
                    low, 
                    close, 
                    volume,
                    symbol: state.symbol
                };
                
                // Update current price
                state.currentPrice = close;
                
                // Add new candle
                state.candles.push(newCandle);
                
                // Keep only last 20000 candles
                if (state.candles.length > 20000) {
                    state.candles = state.candles.slice(-20000);
                }
                
                // Update Y-axis if needed
                updateYAxisRange();
                
                // Auto-follow logic
                if (state.autoScroll) {
                    state.visibleRange = {
                        start: Math.max(0, state.candles.length - 100),
                        end: state.candles.length - 1
                    };
                }
                
                renderChart();
            }, interval);
        }

        // Initialize
        function init() {
            resizeCanvas();
            initCodeMirror();
            resetChart();
            updateActiveIndicators();
            chartCanvas.style.cursor = 'grab';
            startSimulation();
        }

        // Start the application
        init();
    </script>
</body>
</html>
